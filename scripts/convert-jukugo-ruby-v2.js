#!/usr/bin/env node
/**
 * 熟語ルビ変換スクリプト v2
 *
 * 日本語音韻論に基づく分割:
 * - 「ん」は前の漢字に属する（暗記 → あん+き）
 * - 長音「う」は前の漢字に属する（横断 → おう+だん）
 * - 促音「っ」は前の漢字に属する（発表 → はっ+ぴょう）
 *   ※「ツ」「チ」「ク」等の促音便
 */

import { readFileSync, writeFileSync, copyFileSync } from 'fs';
import { fileURLToPath } from 'url';
import { dirname, join } from 'path';

const __filename = fileURLToPath(import.meta.url);
const __dirname = dirname(__filename);

const examplesPath = join(__dirname, '../static/data/examples.json');
const backupPath = join(__dirname, 'examples-backup-v2.json');

// バックアップ作成
copyFileSync(examplesPath, backupPath);
console.log(`バックアップ作成: ${backupPath}`);

const data = JSON.parse(readFileSync(examplesPath, 'utf-8'));

// ========== 音読み辞書（確実なもの） ==========
// 3年生の常用漢字の音読み
const onReadingDict = {
  // あ行
  '悪': 'あく', '安': 'あん', '暗': 'あん', '医': 'い', '委': 'い',
  '意': 'い', '育': 'いく', '員': 'いん', '院': 'いん', '飲': 'いん',
  '運': 'うん', '泳': 'えい', '駅': 'えき', '央': 'おう', '横': 'おう',
  '屋': 'おく', '温': 'おん', '化': 'か', '荷': 'か', '界': 'かい',
  '開': 'かい', '階': 'かい', '寒': 'かん', '感': 'かん', '漢': 'かん',
  '館': 'かん', '岸': 'がん', '起': 'き', '期': 'き', '客': 'きゃく',
  '究': 'きゅう', '急': 'きゅう', '級': 'きゅう', '宮': 'きゅう', '球': 'きゅう',
  '去': 'きょ', '橋': 'きょう', '業': 'ぎょう', '曲': 'きょく', '局': 'きょく',
  '銀': 'ぎん', '区': 'く', '苦': 'く', '具': 'ぐ', '君': 'くん',
  '係': 'けい', '軽': 'けい', '血': 'けつ', '決': 'けつ', '研': 'けん',
  '県': 'けん', '庫': 'こ', '湖': 'こ', '向': 'こう', '幸': 'こう',
  '港': 'こう', '号': 'ごう', '根': 'こん', '祭': 'さい', '皿': 'さら',
  '仕': 'し', '死': 'し', '使': 'し', '始': 'し', '指': 'し',
  '歯': 'し', '詩': 'し', '次': 'じ', '事': 'じ', '持': 'じ',
  '式': 'しき', '実': 'じつ', '写': 'しゃ', '者': 'しゃ', '主': 'しゅ',
  '守': 'しゅ', '取': 'しゅ', '酒': 'しゅ', '受': 'じゅ', '州': 'しゅう',
  '拾': 'しゅう', '終': 'しゅう', '習': 'しゅう', '集': 'しゅう', '住': 'じゅう',
  '重': 'じゅう', '宿': 'しゅく', '所': 'しょ', '暑': 'しょ', '助': 'じょ',
  '昭': 'しょう', '消': 'しょう', '商': 'しょう', '章': 'しょう', '勝': 'しょう',
  '乗': 'じょう', '植': 'しょく', '申': 'しん', '身': 'しん', '神': 'しん',
  '真': 'しん', '深': 'しん', '進': 'しん', '世': 'せ', '整': 'せい',
  '昔': 'せき', '全': 'ぜん', '相': 'そう', '送': 'そう', '想': 'そう',
  '息': 'そく', '速': 'そく', '族': 'ぞく', '他': 'た', '打': 'だ',
  '対': 'たい', '待': 'たい', '代': 'だい', '第': 'だい', '題': 'だい',
  '炭': 'たん', '短': 'たん', '談': 'だん', '着': 'ちゃく', '注': 'ちゅう',
  '柱': 'ちゅう', '丁': 'ちょう', '帳': 'ちょう', '調': 'ちょう', '追': 'つい',
  '定': 'てい', '庭': 'てい', '笛': 'てき', '鉄': 'てつ', '転': 'てん',
  '都': 'と', '度': 'ど', '投': 'とう', '豆': 'とう', '島': 'とう',
  '湯': 'とう', '登': 'とう', '等': 'とう', '動': 'どう', '童': 'どう',
  '農': 'のう', '波': 'は', '配': 'はい', '倍': 'ばい', '箱': 'はこ',
  '畑': 'はた', '発': 'はつ', '反': 'はん', '坂': 'はん', '板': 'はん',
  '皮': 'ひ', '悲': 'ひ', '美': 'び', '鼻': 'び', '筆': 'ひつ',
  '氷': 'ひょう', '表': 'ひょう', '秒': 'びょう', '病': 'びょう', '品': 'ひん',
  '負': 'ふ', '部': 'ぶ', '服': 'ふく', '福': 'ふく', '物': 'ぶつ',
  '平': 'へい', '返': 'へん', '勉': 'べん', '放': 'ほう', '味': 'み',
  '命': 'めい', '面': 'めん', '問': 'もん', '役': 'やく', '薬': 'やく',
  '由': 'ゆ', '油': 'ゆ', '有': 'ゆう', '遊': 'ゆう', '予': 'よ',
  '羊': 'よう', '洋': 'よう', '葉': 'よう', '陽': 'よう', '様': 'よう',
  '落': 'らく', '流': 'りゅう', '旅': 'りょ', '両': 'りょう', '緑': 'りょく',
  '礼': 'れい', '列': 'れつ', '練': 'れん', '路': 'ろ', '和': 'わ',
  // 追加（熟語で使われるもの）
  '記': 'き', '者': 'しゃ', '学': 'がく', '療': 'りょう', '会': 'かい',
  '長': 'ちょう', '健': 'けん', '保': 'ほ', '書': 'しょ', '図': 'と',
  '転': 'てん', '手': 'しゅ', '断': 'だん', '歩': 'ほ', '道': 'どう',
  '子': 'し', '菓': 'か', '地': 'ち', '映': 'えい', '画': 'が',
  '周': 'しゅう', '京': 'きょう', '東': 'とう', '蔵': 'ぞう', '冷': 'れい',
  '車': 'しゃ', '生': 'せい', '心': 'しん', '全': 'ぜん', '魔': 'ま',
  '最': 'さい', '不': 'ふ', '口': 'こう', '号': 'ごう', '報': 'ほう',
  '気': 'き', '天': 'てん', '位': 'い', '黒': 'こく', '大': 'だい',
  '合': 'ごう', '室': 'しつ', '下': 'か', '床': 'しょう', '間': 'かん',
  '時': 'じ', '食': 'しょく', '給': 'きゅう', '付': 'ふ', '町': 'ちょう',
  '台': 'だい', '皇': 'こう', '典': 'てん', '辞': 'じ', '行': 'こう',
  '距': 'きょ', '離': 'り', '走': 'そう',
  // 追加（不足分）
  '一': 'いち', '七': 'しち', '三': 'さん', '上': 'じょう', '中': 'ちゅう',
  '九': 'きゅう', '乳': 'にゅう', '二': 'に', '五': 'ご', '人': 'じん',
  '令': 'れい', '仮': 'か', '企': 'き', '休': 'きゅう', '体': 'たい',
  '何': 'なん', '作': 'さく', '便': 'びん', '信': 'しん', '修': 'しゅう',
  '倉': 'そう', '像': 'ぞう', '儀': 'ぎ', '優': 'ゆう', '光': 'こう',
  '児': 'じ', '入': 'にゅう', '公': 'こう', '内': 'ない', '冗': 'じょう',
  '出': 'しゅつ', '分': 'ぶん', '別': 'べつ', '利': 'り', '到': 'とう',
  '制': 'せい', '券': 'けん', '刻': 'こく', '前': 'ぜん', '剣': 'けん',
  '割': 'かつ', '劇': 'げき', '力': 'りょく', '加': 'か', '労': 'ろう',
  '効': 'こう', '包': 'ほう', '十': 'じゅう', '半': 'はん', '卒': 'そつ',
  '友': 'ゆう', '古': 'こ', '同': 'どう', '名': 'めい', '吸': 'きゅう',
  '呼': 'こ', '回': 'かい', '国': 'こく', '園': 'えん', '型': 'がた',
  '域': 'いき', '場': 'じょう', '境': 'きょう', '壁': 'へき', '士': 'し',
  '売': 'ばい', '変': 'へん', '夕': 'せき', '夜': 'や', '太': 'たい',
  '失': 'しつ', '女': 'じょ', '婚': 'こん', '孔': 'こう', '字': 'じ',
  '宅': 'たく', '宝': 'ほう', '害': 'がい', '家': 'か', '容': 'よう',
  '寧': 'ねい', '射': 'しゃ', '小': 'しょう', '山': 'さん', '年': 'ねん',
  '庁': 'ちょう', '店': 'てん', '引': 'いん', '強': 'きょう', '律': 'りつ',
  '後': 'ご', '得': 'とく', '復': 'ふく', '必': 'ひつ', '志': 'し',
  '応': 'おう', '怪': 'かい', '戦': 'せん', '戯': 'ぎ', '房': 'ぼう',
  '担': 'たん', '招': 'しょう', '掃': 'そう', '授': 'じゅ', '援': 'えん',
  '支': 'し', '故': 'こ', '教': 'きょう', '敬': 'けい', '数': 'すう',
  '文': 'ぶん', '料': 'りょう', '新': 'しん', '方': 'ほう', '日': 'にち',
  '明': 'めい', '暖': 'だん', '木': 'もく', '末': 'まつ', '本': 'ほん',
  '村': 'そん', '来': 'らい', '枝': 'し', '査': 'さ', '校': 'こう',
  '棒': 'ぼう', '極': 'きょく', '歌': 'か', '残': 'ざん', '段': 'だん',
  '殿': 'でん', '毛': 'もう', '民': 'みん', '水': 'すい', '河': 'か',
  '泉': 'せん', '泊': 'はく', '海': 'かい', '液': 'えき', '点': 'てん',
  '然': 'ぜん', '熟': 'じゅく', '熱': 'ねつ', '特': 'とく', '状': 'じょう',
  '猛': 'もう', '王': 'おう', '現': 'げん', '理': 'り', '用': 'よう',
  '田': 'でん', '畔': 'はん', '留': 'りゅう', '番': 'ばん', '的': 'てき',
  '目': 'もく', '省': 'せい', '石': 'せき', '示': 'じ', '社': 'しゃ',
  '祉': 'し', '祝': 'しゅく', '票': 'ひょう', '科': 'か', '秘': 'ひ',
  '積': 'せき', '空': 'くう', '立': 'りつ', '系': 'けい', '紀': 'き',
  '約': 'やく', '紅': 'こう', '紋': 'もん', '納': 'のう', '組': 'そ',
  '経': 'けい', '結': 'けつ', '絶': 'ぜつ', '線': 'せん', '縦': 'じゅう',
  '膚': 'ふ', '自': 'じ', '興': 'きょう', '色': 'しょく', '若': 'じゃく',
  '茶': 'ちゃ', '草': 'そう', '術': 'じゅつ', '街': 'がい', '装': 'そう',
  '西': 'せい', '要': 'よう', '見': 'けん', '親': 'しん', '観': 'かん',
  '言': 'げん', '計': 'けい', '訓': 'くん', '話': 'わ', '語': 'ご',
  '読': 'どく', '課': 'か', '請': 'せい', '謝': 'しゃ', '謡': 'よう',
  '費': 'ひ', '賞': 'しょう', '質': 'しつ', '足': 'そく', '跡': 'せき',
  '輪': 'りん', '近': 'きん', '退': 'たい', '通': 'つう', '過': 'か',
  '達': 'たつ', '郵': 'ゆう', '醤': 'しょう', '野': 'や', '金': 'きん',
  '針': 'しん', '鉛': 'えん', '鉱': 'こう', '関': 'かん', '防': 'ぼう',
  '限': 'げん', '除': 'じょ', '陸': 'りく', '際': 'さい', '電': 'でん',
  '靴': 'か', '頓': 'とん', '首': 'しゅ', '験': 'けん', '高': 'こう', '鳴': 'めい',
};

// ========== 熟語辞書（特殊読み・訓読み・濁音変化・促音） ==========
// 音読み辞書で自動分割できない熟語を明示的に登録
const compoundDict = {
  // === 熟字訓（分割不可） ===
  '童歌': null,
  '夕陽': ['ゆう', 'ひ'],

  // === 4文字以上の熟語 ===
  '保健委員': ['ほ', 'けん', 'い', 'いん'],
  '地下一階': ['ち', 'か', 'いっ', 'かい'],
  '漢和辞典': ['かん', 'わ', 'じ', 'てん'],
  '起床時間': ['き', 'しょう', 'じ', 'かん'],
  '昭和時代': ['しょう', 'わ', 'じ', 'だい'],
  '家族旅行': ['か', 'ぞく', 'りょ', 'こう'],
  '短距離走': ['たん', 'きょ', 'り', 'そう'],
  '天気予報': ['てん', 'き', 'よ', 'ほう'],
  '世界地図': ['せ', 'かい', 'ち', 'ず'],
  '昭和天皇': ['しょう', 'わ', 'てん', 'のう'],
  '自然界': ['し', 'ぜん', 'かい'],
  '自由研究': ['じ', 'ゆう', 'けん', 'きゅう'],
  '高等学校': ['こう', 'とう', 'がっ', 'こう'],
  '農作物': ['のう', 'さく', 'もつ'],

  // === 3文字熟語 ===
  '給食係': ['きゅう', 'しょく', 'がかり'],
  '受付係': ['うけ', 'つけ', 'がかり'],
  '掃除係': ['そう', 'じ', 'がかり'],
  '一丁目': ['いっ', 'ちょう', 'め'],
  '二丁目': ['に', 'ちょう', 'め'],
  '一周期': ['いっ', 'しゅう', 'き'],
  '一等賞': ['いっ', 'とう', 'しょう'],
  '七福神': ['しち', 'ふく', 'じん'],
  '文庫本': ['ぶん', 'こ', 'ほん'],
  '手荷物': ['て', 'に', 'もつ'],
  '日記帳': ['にっ', 'き', 'ちょう'],
  '菓子屋': ['か', 'し', 'や'],
  '発表会': ['はっ', 'ぴょう', 'かい'],
  '神秘的': ['しん', 'ぴ', 'てき'],
  '第一回': ['だい', 'いっ', 'かい'],
  '第一章': ['だい', 'いっ', 'しょう'],
  '結婚式': ['けっ', 'こん', 'しき'],
  '日本酒': ['に', 'ほん', 'しゅ'],
  '畑仕事': ['はたけ', 'し', 'ごと'],

  // === 2文字熟語（促音変化） ===
  '一階': ['いっ', 'かい'],
  '一対': ['いっ', 'つい'],
  '三階': ['さん', 'がい'],
  '学級': ['がっ', 'きゅう'],
  '特急': ['とっ', 'きゅう'],
  '出血': ['しゅっ', 'けつ'],
  '出発': ['しゅっ', 'ぱつ'],
  '出荷': ['しゅっ', 'か'],
  '決定': ['けっ', 'てい'],
  '決心': ['けっ', 'しん'],
  '必死': ['ひっ', 'し'],
  '実験': ['じっ', 'けん'],
  '実際': ['じっ', 'さい'],
  '熱湯': ['ねっ', 'とう'],
  '納豆': ['なっ', 'とう'],
  '列車': ['れっ', 'しゃ'],
  '絶対': ['ぜっ', 'たい'],
  '発見': ['はっ', 'けん'],
  '発車': ['はっ', 'しゃ'],
  '薬局': ['やっ', 'きょく'],
  '鉄橋': ['てっ', 'きょう'],
  '鉄板': ['てっ', 'ぱん'],
  '行列': ['ぎょう', 'れつ'],

  // === 2文字熟語（濁音変化） ===
  '二学期': ['に', 'がっ', 'き'],
  '作業': ['さ', 'ぎょう'],
  '銀河': ['ぎん', 'が'],
  '銀色': ['ぎん', 'いろ'],
  '神宮': ['じん', 'ぐう'],
  '神社': ['じん', 'じゃ'],
  '電波': ['でん', 'ぱ'],
  '岸壁': ['がん', 'ぺき'],
  '黒板': ['こく', 'ばん'],
  '心配': ['しん', 'ぱい'],
  '祭日': ['さい', 'じつ'],
  '過去': ['か', 'こ'],
  '反応': ['はん', 'のう'],

  // === 2文字熟語（訓読み・混合読み） ===
  '港町': ['みなと', 'まち'],
  '薬箱': ['くすり', 'ばこ'],
  '台所': ['だい', 'どころ'],
  '大黒柱': ['だい', 'こく', 'ばしら'],
  '駅前': ['えき', 'まえ'],
  '中央口': ['ちゅう', 'おう', 'ぐち'],
  '横書': ['よこ', 'がき'],
  '本屋': ['ほん', 'や'],
  '部屋': ['へ', 'や'],
  '荷物': ['に', 'もつ'],
  '屋根': ['や', 'ね'],
  '苦手': ['にが', 'て'],
  '手軽': ['て', 'がる'],
  '気軽': ['き', 'がる'],
  '気持': ['き', 'もち'],
  '大皿': ['おお', 'ざら'],
  '小皿': ['こ', 'ざら'],
  '小指': ['こ', 'ゆび'],
  '指輪': ['ゆび', 'わ'],
  '仕事': ['し', 'ごと'],
  '仕上': ['し', 'あげ'],
  '仕方': ['し', 'かた'],
  '仕組': ['し', 'くみ'],
  '若者': ['わか', 'もの'],
  '若葉': ['わか', 'ば'],
  '歯医者': ['は', 'い', 'しゃ'],
  '地主': ['じ', 'ぬし'],
  '留守番': ['る', 'す', 'ばん'],
  '酒屋': ['さか', 'や'],
  '受付': ['うけ', 'つけ'],
  '中州': ['なか', 'す'],
  '中身': ['なか', 'み'],
  '重宝': ['ちょう', 'ほう'],
  '下宿': ['げ', 'しゅく'],
  '近所': ['きん', 'じょ'],
  '商人': ['しょう', 'にん'],
  '勝負': ['しょう', 'ぶ'],
  '相手': ['あい', 'て'],
  '首相': ['しゅ', 'しょう'],
  '世紀': ['せい', 'き'],
  '速足': ['はや', 'あし'],
  '他人': ['た', 'にん'],
  '大使': ['たい', 'し'],
  '大豆': ['だい', 'ず'],
  '大波': ['おお', 'なみ'],
  '注文': ['ちゅう', 'もん'],
  '丁寧': ['てい', 'ねい'],
  '手帳': ['て', 'ちょう'],
  '理由': ['り', 'ゆう'],
  '自由': ['じ', 'ゆう'],
  '横笛': ['よこ', 'ぶえ'],
  '縦笛': ['たて', 'ぶえ'],
  '草笛': ['くさ', 'ぶえ'],
  '氷山': ['ひょう', 'ざん'],
  '登山': ['と', 'ざん'],
  '石橋': ['いし', 'ばし'],
  '目薬': ['め', 'ぐすり'],
  '筆箱': ['ふで', 'ばこ'],
  '本箱': ['ほん', 'ばこ'],
  '鉛筆': ['えん', 'ぴつ'],
  '皮靴': ['かわ', 'ぐつ'],
  '言葉': ['こと', 'ば'],
  '鼻水': ['はな', 'みず'],
  '鼻血': ['はな', 'ぢ'],
  '枝豆': ['えだ', 'まめ'],
  '子羊': ['こ', 'ひつじ'],
  '福引': ['ふく', 'びき'],
  '役目': ['やく', 'め'],
  '役割': ['やく', 'わり'],
  '様子': ['よう', 'す'],
  '品物': ['しな', 'もの'],
  '地面': ['じ', 'めん'],
  '場面': ['ば', 'めん'],
  '坂道': ['さか', 'みち'],
  '路地': ['ろ', 'じ'],
  '両手': ['りょう', 'て'],
  '両足': ['りょう', 'あし'],
  '両目': ['りょう', 'め'],
  '山田': ['やま', 'だ'],
  '高橋': ['たか', 'はし'],
  '平仮名': ['ひら', 'が', 'な'],
  '平等': ['びょう', 'どう'],

  // === ひらがな混じり熟語（漢字+ひらがな+漢字） ===
  '乗り物': ['の', 'もの'],
  '申し込み': ['もうし', 'こみ'],
  '申し出る': ['もうし', 'でる'],
  '真ん中': ['ま', 'なか'],
  '真っ白': ['ま', 'しろ'],
  '真っ赤': ['ま', 'か'],
  '真っ暗': ['ま', 'くら'],
  '世の中': ['よ', 'なか'],
  '送り物': ['おく', 'もの'],
  '波の音': ['なみ', 'おと'],
  '生き死に': ['い', 'しに'],
  '向こう岸': ['む', 'きし'],
  '取り扱い': ['と', 'あつかい'],
  '下り坂': ['くだ', 'ざか'],
  '食べ物': ['た', 'もの'],
  '忘れ物': ['わす', 'もの'],
  '繰り返し': ['く', 'かえし'],
  '溜め息': ['た', 'いき'],

  // === 既存の訓読み熟語 ===
  '悪口': ['わる', 'くち'],
  '横書き': ['よこ', 'がき'],
  '持ち物': ['も', 'もの'],
  '取り消し': ['と', 'けし'],
  '受け取る': ['うけ', 'とる'],
  '待合室': ['まち', 'あい', 'しつ'],
  '歯ブラシ': ['は'],
  '寒がり': ['さむ', 'がり'],
  '助け合い': ['たすけ', 'あい'],
  '問い合わせ': ['とい', 'あわせ'],
};

// ========== ヘルパー関数 ==========

function isKanji(char) {
  const code = char.charCodeAt(0);
  return code >= 0x4E00 && code <= 0x9FFF;
}

function toHiragana(str) {
  return str.replace(/[\u30A1-\u30F6]/g, (match) => {
    return String.fromCharCode(match.charCodeAt(0) - 0x60);
  });
}

function extractKanji(word) {
  return [...word].filter(isKanji);
}

// ========== 音読み分割（辞書ベース） ==========
function splitOnReadingByDict(kanjiChars, reading) {
  const hiragana = toHiragana(reading);

  // 各漢字の読みを辞書から取得
  const kanjiReadings = kanjiChars.map(k => onReadingDict[k]);

  // すべての漢字が辞書にあるか確認
  if (kanjiReadings.every(r => r)) {
    // 読みを結合して元の読みと比較
    const combined = kanjiReadings.join('');
    if (combined === hiragana) {
      return kanjiChars.map((k, i) => ({ kanji: k, reading: kanjiReadings[i] }));
    }
  }

  return null;
}

// ========== 熟語辞書分割（最優先） ==========
function splitByCompoundDict(word) {
  if (compoundDict.hasOwnProperty(word)) {
    const readings = compoundDict[word];
    if (readings === null) {
      return null; // 熟字訓、分割不可
    }
    const kanjiChars = extractKanji(word);
    if (kanjiChars.length === readings.length) {
      return kanjiChars.map((k, i) => ({ kanji: k, reading: readings[i] }));
    }
  }
  return null;
}

// ========== ひらがな混じり熟語の変換 ==========
function convertMixedWord(word, reading) {
  if (!compoundDict.hasOwnProperty(word)) {
    return null;
  }
  const readings = compoundDict[word];
  if (readings === null) {
    return null; // 熟字訓、分割不可
  }

  // 単語を漢字部分に分割
  const parts = [];
  let current = '';
  let isKanjiPart = false;

  for (const char of word) {
    const charIsKanji = isKanji(char);
    if (current === '') {
      current = char;
      isKanjiPart = charIsKanji;
    } else if (charIsKanji === isKanjiPart) {
      current += char;
    } else {
      parts.push({ text: current, isKanji: isKanjiPart });
      current = char;
      isKanjiPart = charIsKanji;
    }
  }
  if (current) {
    parts.push({ text: current, isKanji: isKanjiPart });
  }

  // 漢字部分のみを抽出
  const kanjiParts = parts.filter(p => p.isKanji);
  if (kanjiParts.length !== readings.length) {
    return null;
  }

  // 結果を構築（漢字にルビ、ひらがなはそのまま）
  let readingIndex = 0;
  const result = parts.map(p => {
    if (p.isKanji) {
      return { kanji: p.text, reading: readings[readingIndex++] };
    } else {
      return { kanji: p.text, reading: null }; // ひらがな部分
    }
  });

  return result;
}

// ========== メイン変換ロジック ==========

function convertSentenceWithRuby(sentenceWithRuby, targetWord, reading, type) {
  // 熟語[読み] パターンを検出（漢字のみ、またはひらがな混じり）
  // パターン1: 連続漢字（悪魔、最悪など）
  // パターン2: ひらがな混じり（乗り物、真ん中など）
  const jukugoPattern = /([\u4E00-\u9FFF][\u4E00-\u9FFF\u3040-\u309Fっ]+)\[([^\]]+)\]/g;

  let result = sentenceWithRuby;
  const conversions = [];

  let match;
  while ((match = jukugoPattern.exec(sentenceWithRuby)) !== null) {
    const [fullMatch, kanji, rubyText] = match;
    const kanjiChars = extractKanji(kanji);

    // 漢字が1文字以下ならスキップ（単独漢字は対象外）
    if (kanjiChars.length < 2) {
      continue;
    }

    let splitResult = null;
    let newRuby = null;
    const isMixedWord = kanji !== kanjiChars.join(''); // ひらがな混じりか

    if (isMixedWord) {
      // ひらがな混じり熟語の処理
      const mixedResult = convertMixedWord(kanji, rubyText);
      if (mixedResult) {
        // ひらがな部分はそのまま、漢字部分にはルビを付ける
        newRuby = mixedResult.map(r =>
          r.reading ? `${r.kanji}[${r.reading}]` : r.kanji
        ).join('');
        splitResult = mixedResult;
      }
    } else {
      // 漢字のみの熟語の処理
      // まず熟語辞書をチェック（最優先）
      splitResult = splitByCompoundDict(kanji);

      // 次に音読み辞書でチェック
      if (!splitResult) {
        splitResult = splitOnReadingByDict(kanjiChars, rubyText);
      }

      if (splitResult) {
        newRuby = splitResult.map(r => `${r.kanji}[${r.reading}]`).join('');
      }
    }

    if (splitResult && newRuby) {
      conversions.push({
        original: fullMatch,
        converted: newRuby,
        success: true
      });
    } else {
      conversions.push({
        original: fullMatch,
        kanji,
        reading: rubyText,
        success: false
      });
    }
  }

  // 成功した変換を適用
  for (const conv of conversions) {
    if (conv.success) {
      result = result.replace(conv.original, conv.converted);
    }
  }

  return { result, conversions };
}

// ========== 実行 ==========

const stats = {
  total: 0,
  converted: 0,
  failed: 0,
  skipped: 0,
  failedList: []
};

for (const entry of data) {
  for (const ex of entry.examples) {
    stats.total++;

    const ruby = ex.sentenceWithRuby;
    // 熟語パターン（連続漢字またはひらがな混じり）
    const hasJukugo = /([\u4E00-\u9FFF][\u4E00-\u9FFF\u3040-\u309Fっ]+)\[([^\]]+)\]/.test(ruby);

    if (!hasJukugo) {
      stats.skipped++;
      continue;
    }

    const { result, conversions } = convertSentenceWithRuby(
      ruby,
      ex.targetWord,
      ex.reading,
      ex.type
    );

    const allSuccess = conversions.every(c => c.success);

    if (allSuccess && result !== ruby) {
      ex.sentenceWithRuby = result;
      stats.converted++;
    } else if (!allSuccess) {
      stats.failed++;
      for (const c of conversions) {
        if (!c.success) {
          stats.failedList.push({
            character: entry.character,
            id: ex.id,
            kanji: c.kanji,
            reading: c.reading,
            original: ruby
          });
        }
      }
    } else {
      stats.skipped++;
    }
  }
}

// 結果を保存
writeFileSync(examplesPath, JSON.stringify(data, null, 2), 'utf-8');

// 結果表示
console.log('\n=== 変換結果 ===');
console.log(`総例文数: ${stats.total}`);
console.log(`変換成功: ${stats.converted}`);
console.log(`変換失敗: ${stats.failed}`);
console.log(`変換不要: ${stats.skipped}`);

if (stats.converted + stats.failed > 0) {
  console.log(`成功率: ${((stats.converted / (stats.converted + stats.failed)) * 100).toFixed(1)}%`);
}

if (stats.failedList.length > 0) {
  console.log('\n=== 変換失敗リスト ===');
  stats.failedList.forEach(f => {
    console.log(`  ${f.character} | ${f.kanji}[${f.reading}]`);
  });
}
