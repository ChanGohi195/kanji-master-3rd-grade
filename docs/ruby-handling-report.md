# 熟語ルビ処理に関する技術レポート

## 1. 現状分析

### 1.1 データ構造

```json
{
  "sentence": "悪魔は こわい。",
  "sentenceWithRuby": "悪魔[あくま]は こわい。",
  "sentenceHiragana": "あくまは こわい。",
  "reading": "アク",
  "type": "on",
  "targetWord": "悪魔"
}
```

### 1.2 データ分布（全1000例文）

| パターン | 件数 | 割合 |
|----------|------|------|
| 単一漢字ルビ | 367 | 36.7% |
| 熟語グループルビ | 614 | 61.4% |
| 複数ルビ（分割済） | 14 | 1.4% |
| ルビなし | 0 | 0% |

**熟語の文字数分布:**
- 2文字熟語: 486件
- 3文字熟語: 108件
- 4文字熟語: 20件

### 1.3 送り仮名データ（訓読み414件）

| パターン | 件数 |
|----------|------|
| 送り仮名あり（.付き） | 214 |
| 送り仮名なし | 200 |

---

## 2. 発生している問題

### 2.1 問題1: 熟語ルビのパース不整合

**現在のデータ形式:**
```
悪魔[あくま]
```

**パース結果（文字単位）:**
```
悪 → ruby: undefined
魔 → ruby: "あくま"
```

**問題:** ルビが最後の漢字にだけ付く。W3Cの推奨形式と異なる。

### 2.2 問題2: モード間のデータ競合

| フィールド | 用途 | 値の例 |
|------------|------|--------|
| `reading` | 書きモード（対象漢字の読み） | "アク" |
| `sentenceWithRuby` の `[...]` | 読みモード（熟語全体の読み） | "あくま" |

これらは**別の目的**のデータだが、同じ例文に混在している。

### 2.3 問題3: 送り仮名の非表示

現在のロジック:
```svelte
{:else if isOkurigana && showBlank}
  <!-- 送り仮名はブランク時に隠す -->
```

「悪い」の「い」が完全に消え、文脈が失われる。

---

## 3. W3C Ruby マークアップ標準

### 3.1 三つの基本タイプ

| タイプ | 説明 | 用途 |
|--------|------|------|
| **Mono-ruby** | 1文字に1ルビ | 「悪」に「あく」 |
| **Group-ruby** | 複数文字に1ルビ | 「悪魔」全体に「あくま」 |
| **Jukugo-ruby** | 各文字に対応ルビ、全体処理 | 「悪」「魔」各々にルビ、まとめて表示 |

### 3.2 W3C推奨のマークアップ

**熟語（Jukugo）の推奨形式:**
```html
<ruby>
  <rb>常</rb><rt>じょう</rt>
  <rb>用</rb><rt>よう</rt>
</ruby>
```

**ポイント:**
- 各漢字に対応するルビを個別に持つ
- 1つの`<ruby>`要素で1単語をまとめる
- 行末での分割時、ルビが対応する漢字と一緒に移動できる

### 3.3 非推奨タグ

`<rb>`, `<rtc>`, `<rbc>` は非推奨。以下のみ使用:
- `<ruby>` （コンテナ）
- `<rt>` （ルビテキスト）
- `<rp>` （フォールバック用括弧）

**Sources:**
- [W3C Ruby Styling](https://w3c.github.io/i18n-drafts/articles/ruby/styling.en.html)
- [Rules for Simple Placement of Japanese Ruby](https://w3c.github.io/simple-ruby/)
- [W3C Ruby Markup](https://www.w3.org/International/articles/ruby/markup.en)

---

## 4. 解決策の比較

### 4.1 選択肢A: データ形式を変更（各漢字に個別ルビ）

**変更後のデータ形式:**
```json
{
  "sentenceWithRuby": "悪[あく]魔[ま]は こわい。"
}
```

| 項目 | 評価 |
|------|------|
| W3C準拠 | ◎ 完全準拠 |
| パースの単純さ | ◎ 現在のロジックで動作 |
| データ変更量 | △ 614件の熟語を変換 |
| 保守性 | ◎ 一貫した形式 |
| 行末分割対応 | ◎ 可能 |

**変換例:**
```
悪魔[あくま] → 悪[あく]魔[ま]
安心[あんしん] → 安[あん]心[しん]
東京都[とうきょうと] → 東[とう]京[きょう]都[と]
```

### 4.2 選択肢B: パースロジックを変更（熟語をグループ化）

**コンポーネントでの処理:**
```svelte
<ruby>悪魔<rt>あくま</rt></ruby>
```

| 項目 | 評価 |
|------|------|
| W3C準拠 | ○ Group-rubyとして有効 |
| パースの単純さ | △ 複雑なグループ化ロジックが必要 |
| データ変更量 | ◎ 不要 |
| 保守性 | △ 特殊処理が増える |
| 行末分割対応 | × 不可（グループ全体が移動） |

**問題点:**
- `targetWord` と `sentenceWithRuby` のルビ位置を突合する必要
- 「真っ暗」のような分割ルビ `真[ま]っ暗[くら]` と混在

### 4.3 選択肢C: 用途別フィールド分離

**データ構造:**
```json
{
  "sentence": "悪魔は こわい。",
  "rubyForYomi": "悪魔[あくま]",
  "rubyForKaki": "悪[アク]魔",
  "targetKanjiReading": "アク",
  "compoundReading": "あくま"
}
```

| 項目 | 評価 |
|------|------|
| W3C準拠 | ○ 各用途で適切な形式可能 |
| パースの単純さ | ○ モード別に処理 |
| データ変更量 | × 大幅な再構築 |
| 保守性 | × フィールド増加、同期の複雑さ |

---

## 5. 推奨案

### 5.1 推奨: 選択肢A（データ形式変更）

**理由:**

1. **W3C標準準拠**: Jukugo-rubyの推奨形式と一致
2. **既存の成功例**: `真[ま]っ暗[くら]` 等14件は既にこの形式で問題なし
3. **ロジックの単純さ**: 現在のパーサーがそのまま使える
4. **将来性**: 行末分割、アクセシビリティ対応が容易

### 5.2 実装手順

1. **変換スクリプト作成**
   - 熟語の読みを文字単位に分割
   - 音読み熟語: 漢字数と読みの対応を辞書化
   - 訓読み熟語: パターンマッチで分割

2. **変換の課題**
   - 「安心」→「あん」+「しん」（規則的）
   - 「今日」→「きょ」+「う」？「きょう」+「」？（不規則）
   - 人名・固有名詞の扱い

3. **検証フェーズ**
   - 自動変換 + 手動レビュー
   - 表示テスト

### 5.3 送り仮名の扱い

**現在の問題:**
送り仮名が `showBlank` 時に完全に消える

**推奨対応:**
送り仮名は表示したまま、漢字部分のみブランク化

```
「悪い」→「？い」（送り仮名は表示）
```

これにより文脈が保持され、何の読みを問うているか明確になる。

---

## 6. 変換の実現可能性

### 6.1 音読み熟語（自動変換可能度: 高）

大半は「1漢字=1モーラ or 2モーラ」の規則に従う:
- 安心 [あんしん] → 安[あん]心[しん]
- 医者 [いしゃ] → 医[い]者[しゃ]
- 暗記 [あんき] → 暗[あん]記[き]

### 6.2 訓読み熟語（手動確認推奨）

不規則な読みが多い:
- 悪口 [わるくち] → 悪[わる]口[くち] ✓
- 真っ暗 → 既に分割済み ✓
- 今日 [きょう] → 特殊読み、変換困難

### 6.3 変換困難なケース

| 熟語 | 読み | 問題 |
|------|------|------|
| 今日 | きょう | 「今」単独で「きょ」と読まない |
| 昨日 | きのう | 同上 |
| 大人 | おとな | 熟字訓（全体で1つの読み） |

**対策:** これらはGroup-ruby形式のまま残すか、特殊タグで管理

---

## 7. 結論

### 選択肢Aを推奨する理由

1. **標準準拠**: W3CのJukugo-ruby推奨形式
2. **技術的優位性**: パースロジックがシンプル
3. **部分的成功実績**: 既存14件が同形式で正常動作
4. **段階的移行可能**: 自動変換 → 例外の手動対応

### 次のステップ

1. 変換スクリプトのプロトタイプ作成
2. 自動変換可能な熟語の特定（推定80-90%）
3. 手動対応が必要な熟語のリスト化
4. 送り仮名ロジックの修正

---

## 付録: 参考リンク

- [W3C Ruby Styling](https://w3c.github.io/i18n-drafts/articles/ruby/styling.en.html)
- [Rules for Simple Placement of Japanese Ruby](https://w3c.github.io/simple-ruby/)
- [W3C Ruby Markup](https://www.w3.org/International/articles/ruby/markup.en)
- [Use Cases for Ruby Markup](https://www.w3.org/International/docs/ruby/)
